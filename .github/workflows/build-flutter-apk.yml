name: Build Flutter APK

# Quando executar: a cada push na branch main ou manualmente
on:
  push:
    branches: [ main, master ]
    paths: [ 'mobile/**' ]
  pull_request:
    branches: [ main, master ]
    paths: [ 'mobile/**' ]
  workflow_dispatch: # Permite executar manualmente
    inputs:
      version_name:
        description: 'Version name (e.g., 1.0.1)'
        required: false
        default: '1.0.0'

jobs:
  build-flutter:
    name: Build Flutter APK
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout do cÃ³digo
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Setup Java (necessÃ¡rio para Android)
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    # 3. Setup Flutter
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true

    # 4. Verificar Flutter
    - name: Flutter doctor
      run: flutter doctor -v

    # 5. Instalar dependÃªncias
    - name: Install Flutter dependencies
      working-directory: mobile
      run: flutter pub get

    # 6. Analisar cÃ³digo (opcional)
    - name: Analyze Flutter code
      working-directory: mobile
      run: flutter analyze

    # 7. Executar testes (opcional)
    - name: Run Flutter tests
      working-directory: mobile
      run: flutter test

    # 8. Build APK
    - name: Build APK
      working-directory: mobile
      run: flutter build apk --release

    # 9. Upload APK como artifact
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: WhatsApp-Notifier-${{ github.event.inputs.version_name || github.run_number }}
        path: mobile/build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30

    # 10. Criar release (opcional - apenas na main/master)
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: mobile-v${{ github.run_number }}
        name: WhatsApp Notifier v${{ github.run_number }}
        body: |
          ğŸš€ **Nova versÃ£o do WhatsApp Notifier**
          
          ğŸ“± **APK gerado automaticamente via GitHub Actions**
          
          ### ğŸ“‹ MudanÃ§as nesta versÃ£o:
          - Build #${{ github.run_number }}
          - Commit: ${{ github.sha }}
          
          ### ğŸ“¥ Como instalar:
          1. Baixe o arquivo `app-release.apk`
          2. Permita instalaÃ§Ã£o de fontes desconhecidas
          3. Instale o APK no seu celular
          
          ### âš™ï¸ ConfiguraÃ§Ã£o necessÃ¡ria:
          - URL do servidor: `https://fhd-automacao-industrial-bq67.vercel.app`
          - NÃºmero do WhatsApp para envio das mensagens
          
          ### ğŸ”— Links Ãºteis:
          - Site: https://fhd-automacao-industrial-bq67.vercel.app
          - RepositÃ³rio: ${{ github.server_url }}/${{ github.repository }}
        files: mobile/build/app/outputs/flutter-apk/app-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}